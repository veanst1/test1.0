stages:
  - lint
  - test
  - build
  - deploy
  - review

variables:
  DOCKER_IMAGE: "nginx:alpine"

cache:
  paths:
    - node_modules/

lint_html_css_js:
  stage: lint
  image: node:18-alpine
  script:
    - |
      echo "üîç Starting code quality checks..."
      
      npm install -g htmlhint
      
      echo "üìÑ Checking HTML..."
      htmlhint index.html --config '{"tagname-lowercase": true, "attr-lowercase": true, "attr-value-double-quotes": true}'
      
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ JavaScript (–±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞)
      echo "üìú Checking JavaScript syntax..."
      if grep -q "<script>" index.html; then
        echo "JavaScript found in HTML, performing basic checks..."
        # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ console.log –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        if grep -c "console.log" index.html; then
          echo "‚ö†Ô∏è  console.log statements found"
        fi
      fi
      
      echo "‚úÖ Code quality checks completed"
  artifacts:
    when: always
    reports:
      codequality: gl-codequality-report.json
    paths:
      - gl-codequality-report.json
  only:
    - merge_requests
    - main


functional_tests:
  stage: test
  image: node:18-alpine
  before_script:
    - apk add --no-cache chromium
    - npm init -y
    - npm install puppeteer
  script:
    - |
      echo "üß™ Starting functional tests..."
      
      cat > test.js << 'EOF'
      const puppeteer = require('puppeteer');
      const fs = require('fs');
      
      async function runTests() {
        console.log('üöÄ Launching browser...');
        const browser = await puppeteer.launch({
          executablePath: '/usr/bin/chromium-browser',
          args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
        });
        
        try {
          const page = await browser.newPage();
          const htmlContent = fs.readFileSync('index.html', 'utf8');
          
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          await page.setContent(htmlContent, { waitUntil: 'networkidle0' });
          
          // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
          const title = await page.title();
          console.log(`üìù Page title: "${title}"`);
          
          if (!title.includes('TaskMaster')) {
            throw new Error('Title should contain "TaskMaster"');
          }
          
          // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
          const requiredElements = [
            '#task-title',
            '#add-task-btn',
            '#task-list-container',
            '.stats',
            '.task-input-section',
            '.task-list-section'
          ];
          
          for (const selector of requiredElements) {
            const exists = await page.$(selector) !== null;
            console.log(`${exists ? '‚úÖ' : '‚ùå'} ${selector}`);
            if (!exists) {
              throw new Error(`Missing required element: ${selector}`);
            }
          }
          
          // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
          const initialTasks = await page.$$eval('.task-item', items => items.length);
          console.log(`üìä Initial tasks count: ${initialTasks}`);
          
          // –¢–µ—Å—Ç 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
          console.log('‚ûï Testing task addition...');
          await page.type('#task-title', 'CI/CD Test Task');
          await page.click('#add-task-btn');
          await page.waitForTimeout(1000);
          
          const tasksAfterAddition = await page.$$eval('.task-item', items => items.length);
          console.log(`üìä Tasks after addition: ${tasksAfterAddition}`);
          
          if (tasksAfterAddition <= initialTasks) {
            throw new Error('Task was not added successfully');
          }
          
          // –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
          const totalTasks = await page.$eval('#total-tasks', el => el.textContent);
          console.log(`üìà Total tasks in stats: ${totalTasks}`);
          
          // –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç –¥–ª—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
          await page.screenshot({ path: 'screenshot.png', fullPage: true });
          
          console.log('üéâ All tests passed successfully!');
          
        } finally {
          await browser.close();
        }
      }
      
      runTests().catch(error => {
        console.error('‚ùå Test failed:', error.message);
        process.exit(1);
      });
      EOF
      
      node test.js
  artifacts:
    when: always
    paths:
      - screenshot.png
    reports:
      junit: junit-report.xml
  only:
    - merge_requests
    - main

build_docker_image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - |
      # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx
      cat > nginx.conf << 'EOF'
      events {
          worker_connections 1024;
      }
      http {
          include /etc/nginx/mime.types;
          default_type application/octet-stream;
          sendfile on;
          keepalive_timeout 65;
          
          server {
              listen 80;
              server_name _;
              root /usr/share/nginx/html;
              
              location / {
                  try_files $uri $uri/ =404;
                  add_header X-Frame-Options "SAMEORIGIN";
                  add_header X-Content-Type-Options "nosniff";
              }
              
              location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
          }
      }
      EOF
      
      cat > Dockerfile << 'EOF'
      FROM nginx:alpine

      COPY index.html /usr/share/nginx/html/
      
      COPY nginx.conf /etc/nginx/nginx.conf
      
      HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
        CMD wget --no-verbose --tries=1 --spider http://localhost/ || exit 1
      
      EXPOSE 80
      
      CMD ["nginx", "-g", "daemon off;"]
      EOF
  script:
    - |
      echo "üê≥ Building Docker image..."
      docker build -t taskmaster-app:$CI_COMMIT_SHORT_SHA .
      echo "‚úÖ Docker image built successfully"
      
      docker save taskmaster-app:$CI_COMMIT_SHORT_SHA -o taskmaster-app.tar
  artifacts:
    paths:
      - taskmaster-app.tar
      - Dockerfile
      - nginx.conf
    expire_in: 1 week
  only:
    - main
    - tags

pages:
  stage: deploy
  script:
    - |
      echo "üöÄ Deploying to GitLab Pages..."
      mkdir -p public
      # –ö–æ–ø–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      cp index.html public/
      
      cat > public/index.html << 'EOF'
      <!DOCTYPE html>
      <html lang="ru">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>TaskMaster - GitLab Pages</title>
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
          <style>
              /* –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à CSS —Å—é–¥–∞ */
          </style>
      </head>
      <body>
          <!-- –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à HTML —Å—é–¥–∞ -->
          <script>
              // –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à JavaScript —Å—é–¥–∞
          </script>
      </body>
      </html>
      EOF
      
      cat > public/README.md << 'EOF'
      
      This is a deployment of TaskMaster application on GitLab Pages.
    
      - Add, edit, delete tasks
      - Priority levels
      - Task filtering
      - Local storage
      
      Built with GitLab CI/CD.
      EOF
      
      echo "‚úÖ Successfully prepared for GitLab Pages"
  artifacts:
    paths:
      - public
  only:
    - main

review_app:
  stage: review
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - |
      echo "üîß Setting up Review App for MR !$CI_MERGE_REQUEST_IID"
      
      
      PORT=$((8000 + CI_MERGE_REQUEST_IID % 1000))
      
      cat > server.js << EOF
      const http = require('http');
      const fs = require('fs');
      const path = require('path');
      
      const PORT = process.env.PORT || ${PORT};
      const htmlContent = fs.readFileSync('index.html', 'utf8');
      
      const server = http.createServer((req, res) => {
        if (req.url === '/' || req.url === '/index.html') {
          res.writeHead(200, { 'Content-Type': 'text/html' });
          res.end(htmlContent);
        } else {
          res.writeHead(404);
          res.end('Not found');
        }
      });
      
      server.listen(PORT, () => {
        console.log(\`Review App running on port \${PORT}\`);
      });
      EOF
      
      echo "Review App would run on port: $PORT"
      echo "To run locally: node server.js"
      
      
      cat > review-app-info.md << EOF
      
      
      Merge Request: !$CI_MERGE_REQUEST_IID
      Branch: $CI_COMMIT_REF_NAME
      Commit: $CI_COMMIT_SHORT_SHA
      
      To run this Review App locally:
      
      1. Clone the repository
      2. Checkout branch: $CI_COMMIT_REF_NAME
      3. Run: node server.js
      4. Open: http://localhost:$PORT
      
      Application will be automatically deployed when MR is merged.
      EOF
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: http://$CI_ENVIRONMENT_SLUG.example.com
    on_stop: stop_review
    auto_stop_in: 1 day
  artifacts:
    paths:
      - server.js
      - review-app-info.md
  only:
    - merge_requests

stop_review:
  stage: review
  variables:
    GIT_STRATEGY: none
  script:
    - echo "üõë Stopping Review App for $CI_COMMIT_REF_NAME"
  environment:
    name: review/$CI_COMMIT_REF_NAME
    action: stop
  when: manual
  only:
    - merge_requests

performance_check:
  stage: test
  image: node:18-alpine
  before_script:
    - apk add --no-cache chromium
    - npm install lighthouse puppeteer
  script:
    - |
      echo "üìä Running performance audit..."
      
      cat > lighthouse-test.js << 'EOF'
      const lighthouse = require('lighthouse');
      const puppeteer = require('puppeteer');
      const fs = require('fs');
      
      (async () => {
        const browser = await puppeteer.launch({
          executablePath: '/usr/bin/chromium-browser',
          args: ['--no-sandbox', '--disable-setuid-sandbox']
        });
        
        const htmlContent = fs.readFileSync('index.html', 'utf8');
        const page = await browser.newPage();
        await page.setContent(htmlContent);
        
        // –ü–æ–ª—É—á–∞–µ–º URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const url = page.url();
        
        console.log('Running Lighthouse audit...');
        const result = await lighthouse(url, {
          port: (new URL(browser.wsEndpoint())).port,
          output: 'json',
          onlyCategories: ['performance', 'accessibility', 'best-practices', 'seo']
        });
        
        const lhr = result.lhr;
        
        // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        console.log('\nüìà Lighthouse Scores:');
        console.log('====================');
        Object.values(lhr.categories).forEach(category => {
          console.log(`${category.title}: ${Math.round(category.score * 100)}/100`);
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ performance >= 80
        if (lhr.categories.performance.score < 0.8) {
          console.log('\n‚ö†Ô∏è  Performance score below 80!');
          // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç
        fs.writeFileSync('lighthouse-report.json', JSON.stringify(lhr, null, 2));
        
        await browser.close();
      })().catch(error => {
        console.error('Lighthouse audit failed:', error);
        process.exit(1);
      });
      EOF
      
      node lighthouse-test.js
  artifacts:
    paths:
      - lighthouse-report.json
    reports:
      performance: lighthouse-report.json
  allow_failure: true
  only:
    - main
    - schedules

weekly_full_test:
  stage: test
  image: node:18-alpine
  script:
    - |
      echo "üìÖ Running weekly full test suite..."
      echo "This job runs on schedule and performs comprehensive testing"
      
      echo "‚úÖ Weekly tests completed"
  only:
    - schedules
  when: manual

notify:
  stage: deploy
  image: alpine:latest
  script:
    - |
      echo "üì¢ Sending deployment notifications..."
      
      cat > deploy-info.txt << EOF
      Deployment Information
      ======================
      Project: $CI_PROJECT_NAME
      Branch: $CI_COMMIT_REF_NAME
      Commit: $CI_COMMIT_SHORT_SHA
      Pipeline: $CI_PIPELINE_ID
      Status: $CI_JOB_STATUS
      Deployed to: GitLab Pages
      URL: https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME
      Time: $(date)
      EOF
      
      echo "Deployment info saved to deploy-info.txt"
  when: on_success
  only:
    - main